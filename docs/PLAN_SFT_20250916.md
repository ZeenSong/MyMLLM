# PLAN_SFT_20250916

## 背景
- SFT 阶段需要将 Geoformer 气象数据转化为多模态指令数据集，供后续语言模型监督微调使用。
- 底层原始数据位于 `dataset/3DGeoformer_origin_data/CMIP6_separate_model_up150m_tauxy_Nor_kb.nc`，体量较大且采用 NetCDF 存储。
- 目标是在保持工程流程的前提下，定义一条可复用的“随机采样→处理→标注”管线，并输出可被下游训练脚本消费的 JSONL/Parquet 等格式。

## 本轮目标
- 梳理数据采样、特征提取、格式转换与标注接口的整体流程。
- 明确需要实现的脚本/模块、配置项与输出目录结构，为后续编码做准备。
- 校准验收标准与回滚策略，确保实现路径可控。

## 动作清单
1. 数据摸底与采样策略设计
   - 解析目标 NetCDF 文件的关键变量（如 `temperatureNor`, `tauxNor`, `tauyNor` 等）与维度含义。
   - 评估样本总量与时间跨度，确定随机采样方式（按时间窗口 / 按样本维抽样）。
   - 输出：采样策略说明（采样粒度、窗口长度、预期样本数）、潜在数据清洗需求。
2. 特征转换与序列构造方案
   - 设计从原始张量到模型输入的转换步骤（例如正则化、patch 化、压缩存储）。
   - 确认是否需要生成缩略图/统计指标用于多模态描述，或转存为中间 npz/hdf5。
   - 输出：转换流水线草图、所需依赖列表、预估存储开销。
3. 标注流程定义
   - 梳理 SFT 所需的问答/指令模版，确定标签结构（prompt、response、metadata）。
   - 设计自动标注流程：
     1. 采样后生成描述上下文（如时间段、经纬、高度、关键统计信息）。
     2. 调用规则或语言模型模板自动撰写问题与答案（如“给定 XX 时段的温度异常，预测后续趋势”）。
     3. 对答案执行一致性校验（数值阈值、正则检查）并记录失败案例供人工复核。
   - 产出：标注 schema（JSON Schema 或字段表）、自动标注规则/Prompt 草案、示例若干条、人工兜底流程。
4. 实现计划和任务分解
   - 列出需要新增的脚本/模块（如 `tools/make_sft_data.py`、`src/data/sft_sampler.py`）。
   - 规划配置文件与命令行参数，约定输出目录（建议 `data/sft_raw/` -> `data/sft_labeled/`）。
   - 制定单元/集成验证方式（数据统计、样例可视化）。
5. 验收与文档
   - 明确“完成”标准：生成一批示例样本、通过数据校验脚本、更新 `History.md`。
   - 定义回滚策略与风险点（磁盘占用、采样偏差、标注一致性）。

## 验证方式
- 计划阶段：由协作者评审本计划，确认步骤与输出满足需求。
- 实施阶段（后续迭代中）：执行采样脚本后输出 summary（样本数、维度、缺失率），并抽查若干条标注确认质量。

## 回滚策略
- 如采样策略或转换方案不合适，可退回仅完成数据摸底，保留计划文档并调整方案后再执行。
- 在任何编码落地前，不对原始数据做破坏性修改；中间产物放入新目录，删除即可回滚。
